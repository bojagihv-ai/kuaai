# 카페24 + 로젠택배 송장 자동등록 프로그램 — 프로젝트 개요

## 1. 프로젝트 목적

**보자기천국** (카페24 쇼핑몰 `bojagi1928`)에서 들어오는 주문의 송장번호를
로젠택배 WEB-EDI → 카페24 관리자 패널 전체 과정을 **하나의 웹 화면**에서 처리한다.

| 기존 수동 프로세스 | 자동화 후 |
|---|---|
| 카페24 관리자에서 주문 복사 → 로젠 WEB-EDI에 붙여넣기 | 1클릭으로 주문 조회 + EDI 엑셀 다운로드 |
| 로젠 배정 결과 엑셀 열기 → 카페24에 하나씩 송장 입력 | 엑셀 업로드 → 일괄 등록 |
| 송장 등록 후 각각 배송 추적 사이트 접속 | 배송 조회 탭에서 전체 현황 한눈에 확인 |

## 2. 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                     브라우저 (사용자)                      │
│              kuaai.vercel.app/logen-cafe24.html           │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐          │
│  │ 설정  │ │주문조회│ │송장발급│ │송장등록│ │배송조회│          │
│  └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘          │
│     │        │        │        │        │               │
└─────┼────────┼────────┼────────┼────────┼───────────────┘
      │        │        │        │        │
      │   ┌────▼────────▼────────▼───┐  ┌─▼──────────────┐
      │   │  /api/cafe24  (Vercel)   │  │ /api/logen     │
      │   │  Serverless Proxy        │  │ Serverless     │
      │   └────┬────────┬────────┬───┘  └──┬─────────────┘
      │        │        │        │         │
      │   ┌────▼───┐ ┌──▼───┐ ┌─▼──────┐ ┌▼──────────────┐
      │   │주문 조회│ │토큰   │ │ 송장   │ │tracker.delivery│
      │   │GET     │ │갱신   │ │ 등록   │ │  배송조회 API  │
      │   │/orders │ │/token │ │/ship-  │ │  (무료/공개)   │
      │   │        │ │       │ │ments   │ │               │
      │   └────┬───┘ └──┬───┘ └─┬──────┘ └───────────────┘
      │        │        │       │
      │   ┌────▼────────▼───────▼───────────┐
      │   │   카페24 Admin API v2            │
      │   │   bojagi1928.cafe24api.com       │
      │   │   X-Cafe24-Api-Version: 2025-12-01│
      │   └─────────────────────────────────┘
      │
  ┌───▼───────────────────────────┐
  │  localStorage (브라우저)       │
  │  설정값 영구 저장              │
  └───────────────────────────────┘
```

### 핵심 컴포넌트

| 파일 | 역할 |
|---|---|
| `logen-cafe24.html` | 5탭 SPA UI |
| `logen-cafe24.js` | 클라이언트 로직 (주문조회, 엑셀파싱, 송장등록, 배송조회) |
| `logen-cafe24.css` | 다크테마 스타일 |
| `api/cafe24.js` | Vercel Serverless — 카페24 API 프록시 (CORS 우회) |
| `api/logen.js` | Vercel Serverless — 배송조회 프록시 (tracker.delivery) |
| `vercel.json` | Vercel 라우팅 설정 |

## 3. 실행 요약 (한 페이지)

### 운영 흐름 (매일)

```
1. kuaai.vercel.app/logen-cafe24.html 접속
2. [주문 조회] 탭 → '주문 가져오기' → 미발송(N20) 주문 로드
3. 주문 선택 → '송장 발급 탭으로' → '로젠 EDI 엑셀 다운로드'
4. 로젠 WEB-EDI (logis.ilogen.com) 에 엑셀 업로드 → 운송장번호 배정
5. 로젠 WEB-EDI에서 결과 엑셀 다운로드
6. [송장 등록] 탭 → 결과 파일 업로드 → '카페24에 송장번호 일괄 등록'
7. [배송 조회] 탭 → 전체 배송현황 확인
```

### 토큰 갱신

- Access Token: **2시간** 유효 → 자동 갱신 (Refresh Token 사용)
- Refresh Token: **2주** 유효 → 만료 시 재인증 필요
- 재인증 URL: `https://bojagi1928.cafe24api.com/api/v2/oauth/authorize?...`

## 4. 핵심 결정 및 가정

| 결정 | 이유 |
|---|---|
| Vercel Serverless Proxy 사용 | 카페24 API는 브라우저 CORS 차단 → 서버사이드 필수 |
| `fulfillments` 대신 `shipments` 엔드포인트 | API v2025-12-01에서 fulfillments는 404 반환 |
| `shipping_company_code: '0004'` | 카페24에 등록된 로젠택배 코드 (0014 아님) |
| `status: 'standby'` | 배송대기 상태로 등록 (필수 필드) |
| `mall.write_order` 스코프 추가 | `mall.write_shipping`만으로는 shipments 엔드포인트 권한 부족 |
| tracker.delivery API 사용 | 로젠 공식 Open API (openapi.ilogen.com)는 기업 IP 등록 필요, 타임아웃 |
| localStorage 설정 저장 | 비개발자 사용자가 DB 없이 간편하게 이용 |
| `order_item_code` 자동 조회 | 로젠 엑셀에 order_item_code 없음 → 프록시에서 주문상세 API 호출 |
| SheetJS (xlsx) CDN 사용 | 엑셀 파싱을 브라우저에서 처리 (서버 불필요) |
